## 本章の課題
- 予算と送付率の制約条件のもとで、来客率を最大化するようなダイレクトメールの送付の仕方を決定する

## データ
- 会員数
    - 5000 人
- 会員の年齢区分
- 昨年度の利用回数区分


## 課題の整理
### 数理モデルを通して決定することを整理
- 全会員に対して、３パターンのいずれを送付するか決定する


チラシ | 1000 円クーポン | 2000 円クーポン
-------|-----------------|---------------
o | x | x
o | o | x
o | x | o

### 決定することに対する制約条件
- 各会員に送るダイレクトメールはいずれか１パターン


### ダイレクトメールを送付する目的
- クーポンを付与したことで増加した来客数を最大化させること


### ダイレクトメールを送付することに対する制約条件
1. クーポンを受け取って来院した会員の予算消費期待値の合計が１００万円以下
    - 予算消費期待値 = クーポン金額 * 会員の来店率
2. セグメントごとのダイレクトメール送付下限割合
    - 年齢区分 x 昨年度利用回数区分 の各セグメントに属する会員数の１０％以上に各パターンのダイレクトメールを送付


## データ理解
- 会員データの中身確認
    - `4-1.py`
- 昨年度来院頻度データの中身確認
    - `4-2.py`


## 数理モデリング
1. 会員ひとりひとりに対してどのパターンのダイレクトメールを送付するかを決定する問題と捉える
2. セグメントに対して各パターンのダイレクトメールをそれぞれどの程度送付するかを決定する問題として捉える

### パターン１

#### 各会員に対してどのパターンのダイレクトメールを送付るかを決定

- 会員のリスト
    - $ I $
- ダイレクトメールのパターン
    - $ M = (1, 2, 3) $
- 決定変数
    - 会員 $ i (\in I) $ に対して、あるパターンのダイレクトメール $ m (\in M) $ を送付する場合に $ 1 $ を取る。送付しない場合は $ 0 $ を取る
- $ x_{im} (i \in I, m \in M) $


#### 各会員に対し送付するダイレクトメールはいずれか１つ

$$ \sum_{m \in M} x_{im} = 1 (i \in I) $$

#### クーポン付与による来客増加数を最大化

- 定数
    - 会員 $ i (\in I) $ に対してパターン $ m (\in M) $ のダイレクトメールを送付したときの来店率
    - $ P_{im} \in [0, 1] (i \in I, m \in M) $
- クーポン付与による来客増加数を最大化

$$ \sum_{i \in I} \sum_{m \in M} (P_{im} - P_{i1})x_{im} $$

#### 会員の予算消費期待値の合計は１００万円以下
- 定数
    - ダイレクトメールのパターン $ m (\in M)$ に付与するクーポンの金額
    - $ C_m \in (0, 1000, 2000) (m \in M) $
- 会員の予算消費期待値の合計は１００万円以下

$$ \sum_{i \in I} \sum_{m \in M} C_m P_{im} x_{im} \leq 1,000,000 $$


#### 各パターンのダイレクトメールをそれぞれのセグメントに属する会員１０％以上に送付

- 年齢区分、昨年度来店回数区分によるセグメントのリスト
    - $ S $
- 定数
    - セグメント $ s (\in S) $ に属する会員数
    - $ N_s \in \mathbb{N} (s \in S) $
- 定数
    - 会員 $i (\in I) $ がセグメント $s (\in S) $ に属する場合 $ 1 $、そうでない場合 $ 0 $ となる定数
    - $ Z_{is} \in {0, 1} (i \in I, s \in S) $
- 各パターンのダイレクトメールをそれぞれのセグメントにぞする会員１０％以上に送付

$$ \sum_{i \in I} Z_{is}x_{im} \geq 0.1 \dot N_s (s \in S, m \in M) $$


## 求解
うまく求解できない

- [Pulp ソルバー選択/並列計算](https://inarizuuuushi.hatenablog.com/entry/2019/03/07/090000)


### Pulp で使用できるソルバーの表示

```python
import pulp
def availableSolver(cls):
    for c in cls.__subclasses__():
        try:
            availableSolver(c)
            if c().available():
                print(c)
        except:
            pass
availableSolver(pulp.LpSolver)
```

### Pulp で使えるソルバー
- CBC - https://github.com/coin-or/Cbc
- GLPK - https://gnu.org/software/glpk
- SCIP - https://scipopt.org
- Gurobi - https://gurobi.com
- CPLEX - https://ibm.com/analytics/cplex-optimizer
